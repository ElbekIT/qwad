<!DOCTYPE html>
<html lang="uz">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Battle Room - Tez Roq Yoz</title>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #1a1a1a;
      --bg-secondary: #2c2c2c;
      --bg-tertiary: #3c3c3c;
      --text-primary: #e2b714;
      --text-secondary: #646669;
      --accent: #e2b714;
      --success: #4ade80;
      --error: #ef4444;
      --battle: #ef4444;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100vh;
      font-family: 'JetBrains Mono', monospace;
      background: var(--bg-primary);
      color: var(--text-primary);
      overflow: hidden;
    }

    /* Victory Screen */
    .victory-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(135deg, #1a1a1a 0%, #2c2c2c 50%, #1a1a1a 100%);
      z-index: 9999;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      animation: victoryFadeIn 1s ease-in-out;
    }

    @keyframes victoryFadeIn {
      from { opacity: 0; transform: scale(0.8); }
      to { opacity: 1; transform: scale(1); }
    }

    .victory-crown {
      font-size: 8rem;
      margin-bottom: 30px;
      animation: crownBounce 2s infinite;
      filter: drop-shadow(0 0 20px #e2b714);
    }

    @keyframes crownBounce {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      25% { transform: translateY(-20px) rotate(-5deg); }
      75% { transform: translateY(-10px) rotate(5deg); }
    }

    .victory-title {
      font-size: 4rem;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 20px;
      text-shadow: 0 0 30px rgba(226, 183, 20, 0.8);
      animation: titleGlow 2s ease-in-out infinite alternate;
    }

    @keyframes titleGlow {
      from { text-shadow: 0 0 30px rgba(226, 183, 20, 0.8); }
      to { text-shadow: 0 0 50px rgba(226, 183, 20, 1), 0 0 80px rgba(226, 183, 20, 0.6); }
    }

    .winner-name {
      font-size: 3rem;
      font-weight: 600;
      color: #fff;
      margin-bottom: 30px;
      text-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
      animation: nameShine 3s ease-in-out infinite;
    }

    @keyframes nameShine {
      0%, 100% { color: #fff; }
      50% { color: var(--accent); }
    }

    .victory-stats {
      display: flex;
      gap: 40px;
      margin-bottom: 40px;
      font-size: 1.2rem;
    }

    .victory-stat {
      background: rgba(226, 183, 20, 0.1);
      border: 2px solid var(--accent);
      border-radius: 12px;
      padding: 15px 25px;
      text-align: center;
      animation: statPulse 2s ease-in-out infinite;
    }

    @keyframes statPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .victory-stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--accent);
      display: block;
    }

    .victory-stat-label {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .victory-buttons {
      display: flex;
      gap: 20px;
      margin-top: 30px;
    }

    .victory-btn {
      padding: 15px 30px;
      border: none;
      border-radius: 12px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-family: 'JetBrains Mono', monospace;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .victory-btn-primary {
      background: var(--accent);
      color: var(--bg-primary);
    }

    .victory-btn-primary:hover {
      background: #d4a813;
      transform: translateY(-2px);
    }

    .victory-btn-secondary {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 2px solid var(--bg-tertiary);
    }

    .victory-btn-secondary:hover {
      background: var(--bg-tertiary);
      transform: translateY(-2px);
    }

    /* Fireworks */
    .fireworks-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      z-index: 10000;
    }

    .firework {
      position: absolute;
      width: 4px;
      height: 4px;
      border-radius: 50%;
      animation: fireworkExplode 2s ease-out forwards;
    }

    @keyframes fireworkExplode {
      0% {
        transform: scale(0);
        opacity: 1;
      }
      50% {
        transform: scale(1);
        opacity: 1;
      }
      100% {
        transform: scale(2);
        opacity: 0;
      }
    }

    .firework-particle {
      position: absolute;
      width: 3px;
      height: 3px;
      border-radius: 50%;
      animation: particleMove 1.5s ease-out forwards;
    }

    @keyframes particleMove {
      0% {
        transform: translate(0, 0) scale(1);
        opacity: 1;
      }
      100% {
        transform: translate(var(--dx), var(--dy)) scale(0);
        opacity: 0;
      }
    }

    /* Confetti */
    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      animation: confettiFall 3s linear infinite;
    }

    @keyframes confettiFall {
      0% {
        transform: translateY(-100vh) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(100vh) rotate(360deg);
        opacity: 0;
      }
    }

    /* Main Layout */
    .battle-layout {
      height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    /* Header */
    .header {
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 40px;
      background: var(--bg-primary);
      border-bottom: 1px solid var(--bg-tertiary);
    }

    .room-info {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .room-code {
      background: var(--bg-secondary);
      border: 1px solid var(--accent);
      border-radius: 8px;
      padding: 8px 16px;
      color: var(--accent);
      font-weight: 600;
      font-size: 1.1rem;
      letter-spacing: 2px;
    }

    .room-status {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-secondary);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      animation: pulse 2s infinite;
    }

    .status-dot.waiting {
      background: var(--accent);
    }

    .status-dot.playing {
      background: var(--battle);
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'JetBrains Mono', monospace;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn-secondary {
      background: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--bg-tertiary);
    }

    .btn-secondary:hover {
      background: var(--bg-tertiary);
    }

    .btn-battle {
      background: var(--battle);
      color: white;
    }

    .btn-battle:hover {
      background: #dc2626;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      display: flex;
      gap: 30px;
      padding: 30px 40px;
    }

    /* Players Panel */
    .players-panel {
      width: 300px;
      background: var(--bg-secondary);
      border: 1px solid var(--bg-tertiary);
      border-radius: 16px;
      padding: 25px;
    }

    .players-title {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .player-card {
      background: var(--bg-primary);
      border: 1px solid var(--bg-tertiary);
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      position: relative;
      transition: all 0.3s;
    }

    .player-card.ready {
      border-color: var(--success);
      box-shadow: 0 0 15px rgba(74, 222, 128, 0.2);
    }

    .player-card.host {
      border-color: var(--accent);
      box-shadow: 0 0 15px rgba(226, 183, 20, 0.2);
    }

    .player-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .player-name {
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .player-badge {
      font-size: 0.8rem;
      padding: 2px 8px;
      border-radius: 12px;
      font-weight: 600;
    }

    .badge-host {
      background: var(--accent);
      color: var(--bg-primary);
    }

    .badge-ready {
      background: var(--success);
      color: white;
    }

    .badge-waiting {
      background: var(--text-secondary);
      color: white;
    }

    .player-stats {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .player-progress {
      width: 100%;
      height: 6px;
      background: var(--bg-tertiary);
      border-radius: 3px;
      margin-top: 10px;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), #d4a813);
      border-radius: 3px;
      transition: width 0.3s ease;
      width: 0%;
    }

    /* Game Area */
    .game-area {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .game-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .game-timer {
      font-size: 3rem;
      font-weight: 700;
      color: var(--accent);
      text-shadow: 0 0 20px rgba(226, 183, 20, 0.5);
    }

    .game-stats {
      display: flex;
      gap: 30px;
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-primary);
      display: block;
    }

    .stat-label {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    /* Text Display */
    .text-display {
      background: var(--bg-secondary);
      border: 1px solid var(--bg-tertiary);
      border-radius: 16px;
      padding: 40px;
      margin-bottom: 30px;
      min-height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .text-content {
      font-size: 1.5rem;
      line-height: 2;
      text-align: center;
      max-width: 800px;
    }

    .char {
      position: relative;
      transition: all 0.1s;
    }

    .char.correct {
      color: var(--success);
      background: rgba(74, 222, 128, 0.1);
    }

    .char.incorrect {
      color: var(--error);
      background: rgba(239, 68, 68, 0.2);
    }

    .char.current {
      background: var(--accent);
      color: var(--bg-primary);
      animation: blink 1s infinite;
    }

    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0.3; }
    }

    /* Input Area */
    .input-area {
      background: var(--bg-secondary);
      border: 1px solid var(--bg-tertiary);
      border-radius: 16px;
      padding: 30px;
      text-align: center;
    }

    .typing-input {
      width: 100%;
      background: var(--bg-primary);
      border: 2px solid var(--bg-tertiary);
      border-radius: 12px;
      padding: 20px;
      font-size: 1.3rem;
      color: var(--text-primary);
      font-family: 'JetBrains Mono', monospace;
      outline: none;
      transition: border-color 0.2s;
      text-align: center;
    }

    .typing-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 20px rgba(226, 183, 20, 0.2);
    }

    .typing-input:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .input-hint {
      margin-top: 15px;
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    /* Ready Button */
    .ready-section {
      text-align: center;
      margin-top: 30px;
    }

    .ready-btn {
      padding: 15px 40px;
      font-size: 1.2rem;
      font-weight: 600;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      font-family: 'JetBrains Mono', monospace;
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }

    .ready-btn.not-ready {
      background: var(--success);
      color: white;
    }

    .ready-btn.not-ready:hover {
      background: #22c55e;
      transform: translateY(-2px);
    }

    .ready-btn.ready {
      background: var(--text-secondary);
      color: white;
    }

    .ready-btn.ready:hover {
      background: #52525b;
    }

    /* Waiting Screen */
    .waiting-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 400px;
      text-align: center;
    }

    .waiting-icon {
      font-size: 4rem;
      margin-bottom: 20px;
      animation: spin 2s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    .waiting-title {
      font-size: 2rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 10px;
    }

    .waiting-subtitle {
      color: var(--text-secondary);
      font-size: 1.1rem;
    }

    /* Countdown */
    .countdown-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(26, 26, 26, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .countdown-number {
      font-size: 15rem;
      font-weight: 700;
      color: var(--accent);
      text-shadow: 0 0 50px rgba(226, 183, 20, 0.8);
      animation: countdownPulse 1s ease-in-out;
    }

    @keyframes countdownPulse {
      0% { transform: scale(0.5); opacity: 0; }
      50% { transform: scale(1.2); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }

    /* Notification */
    .notification {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-secondary);
      color: var(--text-primary);
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 500;
      z-index: 1001;
      border: 1px solid var(--bg-tertiary);
      font-size: 0.9rem;
      font-family: 'JetBrains Mono', monospace;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    .notification.success {
      border-color: var(--success);
      color: var(--success);
    }

    .notification.error {
      border-color: var(--error);
      color: var(--error);
    }

    /* Mobile Block */
    .mobile-block {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: var(--bg-primary);
      z-index: 9999;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 40px 20px;
    }

    .mobile-block-icon {
      font-size: 5rem;
      margin-bottom: 30px;
      opacity: 0.8;
    }

    .mobile-block-title {
      font-size: 2rem;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 20px;
      line-height: 1.2;
    }

    .mobile-block-message {
      font-size: 1.2rem;
      color: var(--text-secondary);
      line-height: 1.5;
      max-width: 400px;
    }

    /* Mobile Detection */
    @media (max-width: 1024px) {
      .mobile-block {
        display: flex !important;
      }
      
      .battle-layout {
        display: none !important;
      }
    }
  </style>
</head>
<body>
  <!-- Mobile Block Screen -->
  <div class="mobile-block">
    <div class="mobile-block-icon">🖥️</div>
    <div class="mobile-block-title">BU SAYT GA FAQAT KOMPYUTERDAN KIRSA BO'LADI</div>
    <div class="mobile-block-message">
      UZUR<br><br>
      Bu professional typing game faqat kompyuter va katta ekranlar uchun mo'ljallangan.
      Iltimos, kompyuteringizdan foydalaning.
    </div>
  </div>

  <!-- Victory Screen -->
  <div class="victory-screen" id="victoryScreen">
    <div class="fireworks-container" id="fireworksContainer"></div>
    
    <div class="victory-crown">👑</div>
    <div class="victory-title">VICTORY!</div>
    <div class="winner-name" id="winnerName">Champion</div>
    
    <div class="victory-stats">
      <div class="victory-stat">
        <span class="victory-stat-value" id="victoryWPM">0</span>
        <span class="victory-stat-label">WPM</span>
      </div>
      <div class="victory-stat">
        <span class="victory-stat-value" id="victoryAccuracy">0%</span>
        <span class="victory-stat-label">Accuracy</span>
      </div>
      <div class="victory-stat">
        <span class="victory-stat-value" id="victoryTime">0s</span>
        <span class="victory-stat-label">Time</span>
      </div>
    </div>
    
    <div class="victory-buttons">
      <button class="victory-btn victory-btn-primary" onclick="playAgain()">
        <span>🔄</span>
        <span>Play Again</span>
      </button>
      <button class="victory-btn victory-btn-secondary" onclick="goHome()">
        <span>🏠</span>
        <span>Home</span>
      </button>
    </div>
  </div>

  <!-- Countdown Overlay -->
  <div class="countdown-overlay" id="countdownOverlay">
    <div class="countdown-number" id="countdownNumber">3</div>
  </div>

  <!-- Battle Layout -->
  <div class="battle-layout">
    <!-- Header -->
    <div class="header">
      <div class="room-info">
        <div class="room-code" id="roomCode">LOADING...</div>
        <div class="room-status">
          <div class="status-dot waiting" id="statusDot"></div>
          <span id="roomStatus">Waiting for players...</span>
        </div>
      </div>
      
      <div class="header-actions">
        <button class="btn btn-secondary" onclick="copyRoomCode()">
          <span>📋</span>
          <span>Copy Code</span>
        </button>
        <button class="btn btn-battle" onclick="leaveRoom()">
          <span>🚪</span>
          <span>Leave</span>
        </button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Players Panel -->
      <div class="players-panel">
        <div class="players-title">
          <span>👥</span>
          <span>Players (<span id="playerCount">0</span>/<span id="maxPlayers">0</span>)</span>
        </div>
        <div id="playersList">
          <!-- Players will be loaded here -->
        </div>
      </div>

      <!-- Game Area -->
      <div class="game-area">
        <div class="game-header">
          <div class="game-timer" id="gameTimer">30</div>
          <div class="game-stats">
            <div class="stat-item">
              <span class="stat-value" id="currentWPM">0</span>
              <span class="stat-label">WPM</span>
            </div>
            <div class="stat-item">
              <span class="stat-value" id="currentAccuracy">100%</span>
              <span class="stat-label">Accuracy</span>
            </div>
            <div class="stat-item">
              <span class="stat-value" id="currentProgress">0%</span>
              <span class="stat-label">Progress</span>
            </div>
          </div>
        </div>

        <!-- Text Display -->
        <div class="text-display">
          <div class="text-content" id="textContent">
            <div class="waiting-screen" id="waitingScreen">
              <div class="waiting-icon">⏳</div>
              <div class="waiting-title">Waiting for all players to be ready...</div>
              <div class="waiting-subtitle">Get ready for an epic typing battle!</div>
            </div>
          </div>
        </div>

        <!-- Input Area -->
        <div class="input-area">
          <input type="text" class="typing-input" id="typingInput" placeholder="Type here when the game starts..." disabled>
          <div class="input-hint">Focus on this input and start typing when the game begins</div>
        </div>

        <!-- Ready Section -->
        <div class="ready-section">
          <button class="ready-btn not-ready" id="readyBtn" onclick="toggleReady()">
            <span>✅</span>
            <span>Ready to Battle!</span>
          </button>
        </div>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getDatabase, ref, set, onValue, push, get, remove, serverTimestamp, off } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCR8QE6UHlS8qqp7UIqCxyiXto_xlB0xyI",
    authDomain: "tezroqyoz.firebaseapp.com",
    databaseURL: "https://tezroqyoz-default-rtdb.firebaseio.com",
    projectId: "tezroqyoz",
    storageBucket: "tezroqyoz.firebasestorage.app",
    messagingSenderId: "562891786916",
    appId: "1:562891786916:web:8372d94bf2128fcc127431",
    measurementId: "G-C3F6970S7T"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const user = JSON.parse(localStorage.getItem("sozUser"));
  if (!user) {
    window.location.href = "register.html";
  }

  const roomCode = localStorage.getItem('battleRoomCode');
  if (!roomCode) {
    window.location.href = 'battle.html';
  }

  // Game state
  let gameState = {
    isPlaying: false,
    startTime: null,
    currentText: '',
    typedText: '',
    currentIndex: 0,
    wpm: 0,
    accuracy: 100,
    progress: 0,
    timeLeft: 30
  };

  let roomData = null;
  let gameTimer = null;
  let isReady = false;

  // Sample texts for battle
  const battleTexts = [
    "The quick brown fox jumps over the lazy dog. This pangram contains every letter of the alphabet and is perfect for typing practice.",
    "In the world of competitive typing, speed and accuracy are equally important. Master both to become a true typing champion.",
    "Technology has revolutionized the way we communicate, work, and live. Embrace the digital age with confidence and skill.",
    "Practice makes perfect, but perfect practice makes champions. Focus on accuracy first, then gradually increase your speed.",
    "The art of touch typing is a valuable skill that will serve you well throughout your career and personal endeavors."
  ];

  // Initialize room
  async function initializeRoom() {
    document.getElementById('roomCode').textContent = roomCode;
    
    // Listen to room changes
    const roomRef = ref(db, `battleRooms/${roomCode}`);
    onValue(roomRef, (snapshot) => {
      if (snapshot.exists()) {
        roomData = snapshot.val();
        updateRoomDisplay();
        updatePlayersDisplay();
        checkGameStart();
      } else {
        showNotification('❌ Room not found!', 'error');
        setTimeout(() => {
          window.location.href = 'battle.html';
        }, 2000);
      }
    });
  }

  // Update room display
  function updateRoomDisplay() {
    if (!roomData) return;

    document.getElementById('maxPlayers').textContent = roomData.maxPlayers;
    document.getElementById('playerCount').textContent = roomData.currentPlayers;
    
    const statusDot = document.getElementById('statusDot');
    const roomStatus = document.getElementById('roomStatus');
    
    switch (roomData.status) {
      case 'waiting':
        statusDot.className = 'status-dot waiting';
        roomStatus.textContent = 'Waiting for players...';
        break;
      case 'ready':
        statusDot.className = 'status-dot ready';
        roomStatus.textContent = 'All players ready!';
        break;
      case 'playing':
        statusDot.className = 'status-dot playing';
        roomStatus.textContent = 'Battle in progress!';
        break;
      case 'finished':
        statusDot.className = 'status-dot';
        roomStatus.textContent = 'Battle finished!';
        break;
    }
  }

  // Update players display
  function updatePlayersDisplay() {
    if (!roomData || !roomData.players) return;

    const playersList = document.getElementById('playersList');
    const players = Object.values(roomData.players);
    
    playersList.innerHTML = players.map(player => {
      const isHost = player.phone === roomData.host;
      const isCurrentUser = player.phone === user.phone;
      
      return `
        <div class="player-card ${player.ready ? 'ready' : ''} ${isHost ? 'host' : ''}">
          <div class="player-header">
            <div class="player-name">
              <span>${player.name}</span>
              ${isHost ? '<span class="player-badge badge-host">👑 Host</span>' : ''}
              ${isCurrentUser ? '<span style="opacity: 0.7;">(You)</span>' : ''}
            </div>
            <span class="player-badge ${player.ready ? 'badge-ready' : 'badge-waiting'}">
              ${player.ready ? '✅ Ready' : '⏳ Waiting'}
            </span>
          </div>
          <div class="player-stats">
            <span>WPM: ${Math.round(player.wpm || 0)}</span>
            <span>Progress: ${Math.round(player.progress || 0)}%</span>
          </div>
          <div class="player-progress">
            <div class="progress-bar" style="width: ${player.progress || 0}%"></div>
          </div>
        </div>
      `;
    }).join('');

    // Update ready button state
    const currentPlayer = roomData.players[user.phone];
    if (currentPlayer) {
      isReady = currentPlayer.ready;
      updateReadyButton();
    }
  }

  // Toggle ready state
  window.toggleReady = async function() {
    if (!roomData || gameState.isPlaying) return;

    isReady = !isReady;
    
    try {
      await set(ref(db, `battleRooms/${roomCode}/players/${user.phone}/ready`), isReady);
      updateReadyButton();
      
      if (isReady) {
        showNotification('✅ You are ready!', 'success');
      } else {
        showNotification('⏳ You are not ready', 'info');
      }
    } catch (error) {
      console.error('Error updating ready state:', error);
      showNotification('❌ Error updating ready state!', 'error');
    }
  }

  // Update ready button
  function updateReadyButton() {
    const readyBtn = document.getElementById('readyBtn');
    
    if (isReady) {
      readyBtn.className = 'ready-btn ready';
      readyBtn.innerHTML = '<span>⏳</span><span>Cancel Ready</span>';
    } else {
      readyBtn.className = 'ready-btn not-ready';
      readyBtn.innerHTML = '<span>✅</span><span>Ready to Battle!</span>';
    }
  }

  // Check if game should start
  function checkGameStart() {
    if (!roomData || !roomData.players) return;

    const players = Object.values(roomData.players);
    const allReady = players.length >= 2 && players.every(player => player.ready);
    
    if (allReady && roomData.status === 'waiting') {
      startCountdown();
    }
  }

  // Start countdown
  async function startCountdown() {
    try {
      await set(ref(db, `battleRooms/${roomCode}/status`), 'ready');
      
      const countdownOverlay = document.getElementById('countdownOverlay');
      const countdownNumber = document.getElementById('countdownNumber');
      
      countdownOverlay.style.display = 'flex';
      
      for (let i = 3; i > 0; i--) {
        countdownNumber.textContent = i;
        countdownNumber.style.animation = 'none';
        setTimeout(() => {
          countdownNumber.style.animation = 'countdownPulse 1s ease-in-out';
        }, 10);
        
        // Play countdown sound
        playSound('countdown');
        
        await new Promise(resolve => setTimeout(resolve, 1000));
      }
      
      countdownNumber.textContent = 'GO!';
      countdownNumber.style.color = 'var(--success)';
      playSound('start');
      
      setTimeout(() => {
        countdownOverlay.style.display = 'none';
        startGame();
      }, 1000);
      
    } catch (error) {
      console.error('Error starting countdown:', error);
    }
  }

  // Start game
  async function startGame() {
    try {
      // Select random text
      const selectedText = battleTexts[Math.floor(Math.random() * battleTexts.length)];
      
      await set(ref(db, `battleRooms/${roomCode}/status`), 'playing');
      await set(ref(db, `battleRooms/${roomCode}/gameText`), selectedText);
      await set(ref(db, `battleRooms/${roomCode}/startTime`), Date.now());
      
      // Initialize game state
      gameState.isPlaying = true;
      gameState.startTime = Date.now();
      gameState.currentText = selectedText;
      gameState.typedText = '';
      gameState.currentIndex = 0;
      gameState.timeLeft = 30;
      
      // Show game text
      displayGameText();
      
      // Enable input
      const typingInput = document.getElementById('typingInput');
      typingInput.disabled = false;
      typingInput.placeholder = 'Start typing...';
      typingInput.focus();
      
      // Hide waiting screen
      document.getElementById('waitingScreen').style.display = 'none';
      
      // Start timer
      startGameTimer();
      
      showNotification('🚀 Battle started!', 'success');
      
    } catch (error) {
      console.error('Error starting game:', error);
    }
  }

  // Display game text
  function displayGameText() {
    const textContent = document.getElementById('textContent');
    const text = gameState.currentText;
    
    let html = '';
    for (let i = 0; i < text.length; i++) {
      const char = text[i];
      let className = 'char';
      
      if (i < gameState.currentIndex) {
        className += gameState.typedText[i] === char ? ' correct' : ' incorrect';
      } else if (i === gameState.currentIndex) {
        className += ' current';
      }
      
      html += `<span class="${className}">${char === ' ' ? '&nbsp;' : char}</span>`;
    }
    
    textContent.innerHTML = html;
  }

  // Start game timer
  function startGameTimer() {
    gameTimer = setInterval(() => {
      gameState.timeLeft--;
      document.getElementById('gameTimer').textContent = gameState.timeLeft;
      
      if (gameState.timeLeft <= 0) {
        endGame();
      }
    }, 1000);
  }

  // Handle typing
  document.getElementById('typingInput').addEventListener('input', (e) => {
    if (!gameState.isPlaying) return;
    
    const input = e.target.value;
    gameState.typedText = input;
    gameState.currentIndex = input.length;
    
    // Update display
    displayGameText();
    updateStats();
    updateProgress();
    
    // Check if finished
    if (input.length >= gameState.currentText.length) {
      endGame();
    }
  });

  // Update stats
  function updateStats() {
    const timeElapsed = (Date.now() - gameState.startTime) / 1000;
    const wordsTyped = gameState.typedText.length / 5;
    const wpm = timeElapsed > 0 ? Math.round((wordsTyped / timeElapsed) * 60) : 0;
    
    let correctChars = 0;
    for (let i = 0; i < gameState.typedText.length; i++) {
      if (gameState.typedText[i] === gameState.currentText[i]) {
        correctChars++;
      }
    }
    
    const accuracy = gameState.typedText.length > 0 ? Math.round((correctChars / gameState.typedText.length) * 100) : 100;
    const progress = Math.round((gameState.typedText.length / gameState.currentText.length) * 100);
    
    gameState.wpm = wpm;
    gameState.accuracy = accuracy;
    gameState.progress = progress;
    
    document.getElementById('currentWPM').textContent = wpm;
    document.getElementById('currentAccuracy').textContent = accuracy + '%';
    document.getElementById('currentProgress').textContent = progress + '%';
  }

  // Update progress in database
  async function updateProgress() {
    try {
      await set(ref(db, `battleRooms/${roomCode}/players/${user.phone}/wpm`), gameState.wpm);
      await set(ref(db, `battleRooms/${roomCode}/players/${user.phone}/progress`), gameState.progress);
    } catch (error) {
      console.error('Error updating progress:', error);
    }
  }

  // End game
  async function endGame() {
    if (!gameState.isPlaying) return;
    
    gameState.isPlaying = false;
    clearInterval(gameTimer);
    
    // Disable input
    document.getElementById('typingInput').disabled = true;
    
    try {
      // Update final stats
      await set(ref(db, `battleRooms/${roomCode}/players/${user.phone}/finalWPM`), gameState.wpm);
      await set(ref(db, `battleRooms/${roomCode}/players/${user.phone}/finalAccuracy`), gameState.accuracy);
      await set(ref(db, `battleRooms/${roomCode}/players/${user.phone}/finalProgress`), gameState.progress);
      await set(ref(db, `battleRooms/${roomCode}/players/${user.phone}/finished`), true);
      
      // Check if all players finished
      checkGameEnd();
      
    } catch (error) {
      console.error('Error ending game:', error);
    }
  }

  // Check if game should end
  async function checkGameEnd() {
    if (!roomData || !roomData.players) return;
    
    const players = Object.values(roomData.players);
    const allFinished = players.every(player => player.finished || false);
    
    if (allFinished) {
      await set(ref(db, `battleRooms/${roomCode}/status`), 'finished');
      
      // Determine winner
      const winner = players.reduce((prev, current) => {
        const prevScore = (prev.finalWPM || 0) * (prev.finalAccuracy || 0) / 100;
        const currentScore = (current.finalWPM || 0) * (current.finalAccuracy || 0) / 100;
        return currentScore > prevScore ? current : prev;
      });
      
      await set(ref(db, `battleRooms/${roomCode}/winner`), winner);
      
      // Show victory screen
      setTimeout(() => {
        showVictoryScreen(winner);
      }, 1000);
    }
  }

  // Show victory screen
  function showVictoryScreen(winner) {
    const victoryScreen = document.getElementById('victoryScreen');
    const winnerName = document.getElementById('winnerName');
    const victoryWPM = document.getElementById('victoryWPM');
    const victoryAccuracy = document.getElementById('victoryAccuracy');
    const victoryTime = document.getElementById('victoryTime');
    
    winnerName.textContent = winner.name;
    victoryWPM.textContent = Math.round(winner.finalWPM || 0);
    victoryAccuracy.textContent = Math.round(winner.finalAccuracy || 0) + '%';
    victoryTime.textContent = (30 - gameState.timeLeft) + 's';
    
    victoryScreen.style.display = 'flex';
    
    // Create fireworks
    createFireworks();
    createConfetti();
    
    // Play victory sound
    playSound('victory');
  }

  // Create fireworks
  function createFireworks() {
    const container = document.getElementById('fireworksContainer');
    const colors = ['#e2b714', '#4ade80', '#ef4444', '#3b82f6', '#a855f7'];
    
    for (let i = 0; i < 5; i++) {
      setTimeout(() => {
        const firework = document.createElement('div');
        firework.className = 'firework';
        firework.style.left = Math.random() * 100 + '%';
        firework.style.top = Math.random() * 100 + '%';
        firework.style.background = colors[Math.floor(Math.random() * colors.length)];
        
        container.appendChild(firework);
        
        // Create particles
        for (let j = 0; j < 12; j++) {
          const particle = document.createElement('div');
          particle.className = 'firework-particle';
          particle.style.left = firework.style.left;
          particle.style.top = firework.style.top;
          particle.style.background = colors[Math.floor(Math.random() * colors.length)];
          
          const angle = (j * 30) * Math.PI / 180;
          const distance = 100 + Math.random() * 100;
          particle.style.setProperty('--dx', Math.cos(angle) * distance + 'px');
          particle.style.setProperty('--dy', Math.sin(angle) * distance + 'px');
          
          container.appendChild(particle);
          
          setTimeout(() => particle.remove(), 1500);
        }
        
        setTimeout(() => firework.remove(), 2000);
      }, i * 500);
    }
  }

  // Create confetti
  function createConfetti() {
    const colors = ['#e2b714', '#4ade80', '#ef4444', '#3b82f6', '#a855f7'];
    
    for (let i = 0; i < 50; i++) {
      setTimeout(() => {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * 100 + '%';
        confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animationDelay = Math.random() * 3 + 's';
        confetti.style.animationDuration = (Math.random() * 3 + 2) + 's';
        
        document.body.appendChild(confetti);
        
        setTimeout(() => confetti.remove(), 6000);
      }, i * 100);
    }
  }

  // Play sound
  function playSound(type) {
    // Create audio context for sound effects
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    
    let frequency, duration;
    
    switch (type) {
      case 'countdown':
        frequency = 800;
        duration = 0.1;
        break;
      case 'start':
        frequency = 1000;
        duration = 0.3;
        break;
      case 'victory':
        // Play victory melody
        const notes = [523, 659, 784, 1047];
        notes.forEach((freq, index) => {
          setTimeout(() => {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = freq;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
          }, index * 200);
        });
        return;
      default:
        return;
    }
    
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.frequency.value = frequency;
    oscillator.type = 'sine';
    
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
    
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + duration);
  }

  // Copy room code
  window.copyRoomCode = function() {
    navigator.clipboard.writeText(roomCode).then(() => {
      showNotification('📋 Room code copied!', 'success');
    });
  }

  // Leave room
  window.leaveRoom = async function() {
    if (confirm('Are you sure you want to leave the battle?')) {
      try {
        // Remove player from room
        await remove(ref(db, `battleRooms/${roomCode}/players/${user.phone}`));
        
        // Update player count
        if (roomData && roomData.currentPlayers > 1) {
          await set(ref(db, `battleRooms/${roomCode}/currentPlayers`), roomData.currentPlayers - 1);
        } else {
          // Delete room if last player
          await remove(ref(db, `battleRooms/${roomCode}`));
        }
        
        localStorage.removeItem('battleRoomCode');
        window.location.href = 'battle.html';
        
      } catch (error) {
        console.error('Error leaving room:', error);
        showNotification('❌ Error leaving room!', 'error');
      }
    }
  }

  // Victory screen actions
  window.playAgain = function() {
    window.location.reload();
  }

  window.goHome = function() {
    localStorage.removeItem('battleRoomCode');
    window.location.href = 'index.html';
  }

  // Notification system
  function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.remove();
    }, 3000);
  }

  // Initialize
  initializeRoom();

  // Cleanup on page unload
  window.addEventListener('beforeunload', () => {
    if (roomData && roomData.players && roomData.players[user.phone]) {
      // Remove player from room
      remove(ref(db, `battleRooms/${roomCode}/players/${user.phone}`));
    }
  });
</script>

<script>
  function showInsult() {
    alert("Urinma! Baribir hech nima qilolmaysan.\nKod senga emas! 🚫🤬");

    document.body.innerHTML = `
      <div style="display:flex;justify-content:center;align-items:center;height:100vh;background:black;color:crimson;font-size:30px;font-family:'Arial';text-align:center;padding:20px;">
        <div>
          <p>🚨 URINMA! 🚨</p>
          <p>Sen nimani bosma, kodni ololmaysan!</p>
          <p><b>Сайтни сносиман, бошқа қайтма!</b></p>
          <p><i>你无论按什么键，都无法看到源代码！</i></p>
          <p><u>Кодни олиш мумкин эмас, ахмоқ!</u></p>
        </div>
      </div>
    `;
  }

  const blockedKeys = ['u', 'U', 'g', 'G', 'п', 'П', 'c', 'C', 's', 'S', 'i', 'I', 'j', 'J'];

  window.addEventListener("keydown", function (e) {
    const key = e.key.toLowerCase();
    
    if (
      e.keyCode === 123 || 
      (e.ctrlKey && blockedKeys.includes(e.key)) || 
      (e.ctrlKey && e.shiftKey && blockedKeys.includes(e.key))
    ) {
      e.preventDefault();
      showInsult();
    }
  });

  window.addEventListener("contextmenu", function (e) {
    e.preventDefault();
    showInsult();
  });

  document.addEventListener("copy", function (e) {
    e.preventDefault();
    showInsult();
  });

  (function devtoolsDetector() {
    const detector = new Function("debugger");
    setInterval(() => detector(), 100);
  })();

  if (window.top !== window.self) {
    window.top.location = window.self.location;
  }
</script>

<script src="js/protection.js"></script>

</body>
</html>
